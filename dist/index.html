<!doctype html><html><head><title>js13k-2d example</title><style>body,canvas,html{margin:0;border:0;padding:0;display:block;overflow:hidden}#view{max-width:800px;max-height:600px;width:100%;height:100%;position:absolute;top:50%;left:50%;-moz-transform:translate(-50%,-50%);-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}#info{position:absolute;top:0;left:90px;font-family:monospace;font-size:20px}</style><script type="module" crossorigin>class t{constructor(t,e,i){this.l=t,this.c=e,this.n=i,this.p=null}r(){this.p?this.p.n=this.n:this.l.h=this.n,this.n&&(this.n.p=this.p)}}class e{constructor(){this.h=null}add(e){const i=new t(this,e,this.h);return this.h&&(this.h.p=i),this.h=i,i}i(t){let e=this.h;for(;e;)t(e.c),e=e.n}}const i=34962,n=5121,s=3553,r={p:{t:0}};class a{constructor(t){this.z=t,this.o=new e,this.t=new e}add(t){t.remove(),t.l=this,t.n=(1!==t.a||0===t.frame.p.a?this.t:this.o).add(t)}}const o=(t,e)=>{const c=new a(0),l=[c],h=52,u=new ArrayBuffer(3407820),p=new Float32Array(u),f=new Uint32Array(u),{Point:d}=o,m=Object.assign({antialias:!1,alpha:!1},e),w=m.alpha?1:770,g=m.scale||1;delete m.scale;const y=t.getContext("webgl",m),x=y.getExtension("ANGLE_instanced_arrays"),v=(t,e)=>{const i=y.createShader(e);return y.shaderSource(i,t),y.compileShader(i),i},T=y.createProgram();y.attachShader(T,v("attribute vec2 g;\nattribute vec2 a;\nattribute vec2 t;\nattribute float r;\nattribute vec2 s;\nattribute vec4 u;\nattribute vec4 c;\nattribute float z;\nuniform mat4 m;\nvarying vec2 v;\nvarying vec4 i;\nvoid main(){\nv=u.xy+g*u.zw;\ni=c.abgr;\nvec2 p=(g-a)*s;\nfloat q=cos(r);\nfloat w=sin(r);\np=vec2(p.x*q-p.y*w,p.x*w+p.y*q);\np+=a+t;\ngl_Position=m*vec4(p,z,1);}",35633)),y.attachShader(T,v("precision mediump float;\nuniform sampler2D x;\nuniform float j;\nvarying vec2 v;\nvarying vec4 i;\nvoid main(){\nvec4 c=texture2D(x,v);\ngl_FragColor=c*i;\nif(j>0.0){\nif(c.a<j)discard;\ngl_FragColor.a=1.0;};}",35632)),y.linkProgram(T);const b=(t,e,i)=>{y.bindBuffer(t,y.createBuffer()),y.bufferData(t,e,i||35044)},A=(t,e,i,n,s,r,a)=>{const o=y.getAttribLocation(T,t);y.enableVertexAttribArray(o),y.vertexAttribPointer(o,e,r||5126,!!a,i||0,s||0),n&&x.vertexAttribDivisorANGLE(o,n)};b(34963,new Uint8Array([0,1,2,2,1,3])),b(i,new Float32Array([0,0,0,1,1,0,1,1])),A("g",2),b(i,u,35048),A("a",2,h,1),A("s",2,h,1,8),A("r",1,h,1,16),A("t",2,h,1,20),A("u",4,h,1,28),A("c",4,h,1,44,n,!0),A("z",1,h,1,48);const P=t=>y.getUniformLocation(T,t),S=P("m"),E=P("x"),D=P("j");let R,z,F,_,M=0;const L=()=>{R=0|t.clientWidth,z=0|t.clientHeight;const e=t.width!==R||t.height!==z;return t.width=R,t.height=z,e},C=()=>{M&&(y.blendFunc(_?1:w,_?0:771),y.depthFunc(_?513:515),y.bindTexture(s,F.p.t),y.uniform1i(E,F.p.t),y.uniform1f(D,_?F.p.a:0),y.bufferSubData(i,0,p.subarray(0,13*M)),x.drawElementsInstancedANGLE(4,6,n,0,M),M=0)},B=t=>{if(!t.visible)return;65535===M&&C();const{frame:e}=t,{uvs:i}=e;F.p.t!==e.p.t&&(F.p.t&&C(),F=e);let n=13*M;p[n++]=e.anchor.x,p[n++]=e.anchor.y,p[n++]=t.scale.x*e.size.x,p[n++]=t.scale.y*e.size.y,p[n++]=t.rotation,p[n++]=t.position.x,p[n++]=t.position.y,p[n++]=i[0],p[n++]=i[1],p[n++]=i[2],p[n++]=i[3],f[n++]=((16777215&t.tint)<<8|255*t.a&255)>>>0,p[n]=t.l.z,M++},k={gl:y,camera:{at:new d,to:new d,angle:0},background(t,e,i,n){y.clearColor(t,e,i,0===n?0:n||1)},layer(t){let e=l.find((e=>e.z===t));return e||(e=new a(t),l.push(e),l.sort(((t,e)=>e.z-t.z))),e},add(t){c.add(t)},texture(t,e,i,r){const a=t.width,o=t.height,c=y.createTexture();return y.bindTexture(s,c),y.texParameteri(s,10240,9728|+i),y.texParameteri(s,10241,9728|+i|+r<<8|+r<<1),y.texParameteri(s,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(s,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texImage2D(s,0,6408,6408,n,t),r&&y.generateMipmap(s),{size:new d(a,o),anchor:new d,uvs:[0,0,1,1],p:{a:0===e?0:e||1,t:c},frame(t,e,i){return{size:e,anchor:i||this.anchor,uvs:[t.x/a,t.y/o,e.x/a,e.y/o],p:this.p}}}},resize:L,render(){L();let t=(o=2*(s=1/((e=R*g)-0)),c=2*(a=1/(0-(i=z*g))),h=-(e+0)*s,u=-(0+i)*a,(n=new Array(16))[0]=o,n[4]=0,n[8]=0,n[12]=h,n[1]=0,n[5]=c,n[9]=0,n[13]=u,n[2]=0,n[6]=0,n[10]=-.01,n[14]=-0,n[3]=0,n[7]=0,n[11]=0,n[15]=1,n);var e,i,n,s,a,o,c,h,u;y.useProgram(T),y.enable(3042),y.enable(2929),y.uniformMatrix4fv(S,!1,t),y.viewport(0,0,R,z),y.clear(16640),F=r,_=!0,l.forEach((t=>t.o.i(B))),C(),_=!1;for(let r=l.length-1;r>=0;r--)l[r].t.i(B);C()}};return L(),k};o.Point=class{constructor(t,e){if(!(this instanceof o.Point))return new o.Point(t,e);this.set(t,e)}set(t,e){return this.x=t||0,this.y=e||(0!==e?this.x:0),this}},o.Sprite=class t{constructor(e,i){if(!(this instanceof t))return new t(e,i);Object.assign(this,{frame:e,visible:!0,position:new o.Point,rotation:0,scale:new o.Point(1),tint:16777215,a:1,l:null,n:null},i)}get alpha(){return this.a}set alpha(t){const e=1>t&&1===this.a||1===t&&1>this.a;this.a=t,e&&this.frame.p.a>0&&this.l&&this.l.add(this)}remove(){this.n&&this.n.r(),this.l=null,this.n=null}};const c=""+new URL("atlas-C6FgK4Gw.png",import.meta.url).href,{Point:l,Sprite:h}=o;class u extends l{add(t){return new u(t.x+this.x,t.y+this.y)}}const p=new u(8,8),f=o(view,{scale:1/3}),d=(t,e,i,n)=>{const s=new h(e.frame),r=new u(8*i+p.x,8*n+p.y);s.position.set(r.x,r.y),t.add(s)},m=[];console.log(c);const w=await(g=c,new Promise((t=>{if(m[g])t(m[g]);else{const e=new Image;e.crossOrigin="anonymous",e.onerror=e.onload=()=>{const i=f.texture(e,1);m[g]=i,t(i)},e.src=g}})));var g;class y{constructor(t,e){this.frame=w.frame(new l(8*t,8*e),new l(8,8))}}class x{constructor(t,e,i,n={}){this.flipX=n.flipX||!1,this.flipY=n.flipY||!1,this.frames=Array(i);for(let s=0;i>s;s++){let i=w.frame(t,e);this.frames[s]=i,t.x+=e.x,this.flipX&&(i.uvs[0]=i.uvs[0]+i.uvs[2],i.uvs[2]=-i.uvs[2]),this.flipY&&(i.uvs[1]=i.uvs[1]+i.uvs[3],i.uvs[3]=-i.uvs[3])}this.frameDurations=Array(i),this.frameDurations.fill(n.frameDuration||.1),this.loop=n.loop||!0,this.numFrames=i}}class v{constructor(t,e){this.resource=t,this.currFrame=0,this.currTime=0,this.sprite=e,this.sprite.frame=this.resource.frames[0]}nextFrame(){this.currFrame<this.resource.numFrames-1?this.currFrame++:this.resource.loop&&(this.currFrame=0),this.sprite.frame=this.resource.frames[this.currFrame]}update(t){for(this.currTime+=t;this.currTime>this.resource.frameDurations[this.currFrame];)this.currTime-=this.resource.frameDurations[this.currFrame],this.nextFrame()}}const{Point:T,Sprite:b}=o,A="idle",P="moving",S="down",E="left",D="right";let R=[];const z=()=>R;class F{constructor(t,e,i){this.direction=S,this.sprite=null,this.state=null,this.speed=10,this.isSelected=!1,this.anims=i}get size(){return this.sprite.frame.size}get pos(){return this.sprite.position}selected(t=!0){this.isSelected=t,this.sprite&&(this.sprite.tint=t?65280:16777215)}update(t){}getAnimResource(){if(this.state==A)return this.anims[A];const t=this.anims[this.state];if(null==t)return this.anims[A];const e=t[this.direction];return null==e?this.anims[A]:e}setState(t){this.state!=t&&(this.state=t,this.currAnim=new v(this.getAnimResource(),this.sprite))}setDirection(t){this.direction!=t&&(this.direction=t,this.currAnim=new v(this.getAnimResource(),this.sprite))}}let _=32;const M=new x(new u(0,_),new u(9),8);_+=9;const L=new x(new u(0,_),new u(9),8),C=new x(new u(0,_),new u(9),8,{flipX:!0});_+=9;const B=new x(new u(0,_),new u(9),8);_+=9;const k=new x(new u(0,_),new u(9),8);_+=9,new x(new u(0,_),new u(9),8),_+=9,new x(new u(0,_),new u(9),4,{loop:!1});class O extends F{constructor(t,e){let i=[];i.up=B,i[S]=k,i[E]=L,i[D]=C;let n=[];n[A]=M,n[P]=i,super(t,e,n),this.sprite=new b(this.anims[A].frames[0]),this.sprite.position.set(t,e),this.setState(A),this.target={x:t,y:e},f.layer(2).add(this.sprite)}moveTo(t,e){this.target.x=t,this.target.y=e,this.setState(P),this.update(0)}update(t){if(this.currAnim&&this.currAnim.update(t),this.state===P){let e=this.target.x-this.pos.x,i=this.target.y-this.pos.y;Math.abs(e)>Math.abs(i)?e>0?this.setDirection(D):this.setDirection(E):i>0?this.setDirection(S):this.setDirection("up"),console.log(this.direction);let n=Math.sqrt(e*e+i*i);1>n?(this.pos.x=this.target.x,this.pos.y=this.target.y,this.setState(A),this.sprite.position.set(this.pos.x,this.pos.y)):(this.pos.x+=e/n*this.speed*t,this.pos.y+=i/n*this.speed*t,this.sprite.position.set(this.pos.x,this.pos.y))}}}function j(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var G;"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;const I=new(j({exports:{}}.exports=((G=function(){function t(t){return n.appendChild(t.dom),t}function e(t){for(var e=0;e<n.children.length;e++)n.children[e].style.display=e===t?"block":"none";i=t}var i=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",(function(t){t.preventDefault(),e(++i%n.children.length)}),!1);var s=(performance||Date).now(),r=s,a=0,o=t(new G.Panel("FPS","#0ff","#002")),c=t(new G.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=t(new G.Panel("MB","#f08","#201"));return e(0),{REVISION:16,dom:n,addPanel:t,showPanel:e,begin:function(){s=(performance||Date).now()},end:function(){a++;var t=(performance||Date).now();if(c.update(t-s,200),t>r+1e3&&(o.update(1e3*a/(t-r),100),r=t,a=0,l)){var e=performance.memory;l.update(e.usedJSHeapSize/1048576,e.jsHeapSizeLimit/1048576)}return t},update:function(){s=this.end()},domElement:n,setMode:e}}).Panel=function(t,e,i){var n=1/0,s=0,r=Math.round,a=r(window.devicePixelRatio||1),o=80*a,c=48*a,l=3*a,h=2*a,u=3*a,p=15*a,f=74*a,d=30*a,m=document.createElement("canvas");m.width=o,m.height=c,m.style.cssText="width:80px;height:48px";var w=m.getContext("2d");return w.font="bold "+9*a+"px Helvetica,Arial,sans-serif",w.textBaseline="top",w.fillStyle=i,w.fillRect(0,0,o,c),w.fillStyle=e,w.fillText(t,l,h),w.fillRect(u,p,f,d),w.fillStyle=i,w.globalAlpha=.9,w.fillRect(u,p,f,d),{dom:m,update:function(c,g){n=Math.min(n,c),s=Math.max(s,c),w.fillStyle=i,w.globalAlpha=1,w.fillRect(0,0,o,p),w.fillStyle=e,w.fillText(r(c)+" "+t+" ("+r(n)+"-"+r(s)+")",l,h),w.drawImage(m,u+a,p,f-a,d,u,p,f-a,d),w.fillRect(u+f-a,p,a,d),w.fillStyle=i,w.globalAlpha=.9,w.fillRect(u+f-a,p,a,r((1-c/g)*d))}}},G)));document.body.appendChild(I.dom);const N=document.getElementById("view"),{gl:U}=f;console.log(U),f.background(.3,.3,1,0),f.camera.at.set(0,0),f.camera.to.set(0);const X=f.layer(0),q=f.layer(1),H=new y(0,0),W=new y(0,1),Y=new y(0,2);new y(1,0),new y(1,1),new y(1,2),new y(1,3);const V=new y(2,0),K=new y(2,1),J=new y(2,2),$=new y(2,3),Q=new y(3,0),Z=new y(4,0),tt=new y(3,1),et=new y(4,1),it=["TTTTTTt.......................","TTTTTt........................","TTTt..........................","TTt...........................","t.............................","..............................","..............................","..............................","..............................","..............cc..............","..............cc..............","..............................","..............................","..............................","..............................","..............................","..............................","...T..........................","..TTt.........................",".TTTTT........................"],nt=new u(it[0].length,it.length),st=[H,W,Y];for(let lt=0;lt<nt.y;lt++)for(let t=0;t<nt.x;t++){const e=it[lt][t];let i;if("."==e)i=st[Math.floor(Math.random()*st.length)];else if("t"==e)i=$;else if("T"==e)lt==nt.y-1||"T"==it[lt+1][t]?(i=K,lt>0&&"T"!=it[lt-1][t]&&d(q,V,t,lt-1)):i=J;else if("c"==e){const e=lt<nt.y-1&&"c"==it[lt+1][t],n=t<nt.x-1&&"c"==it[lt][t+1];i=e?n?Q:Z:n?tt:et}i&&d(X,i,t,lt)}const rt=U.getExtension("WEBGL_debug_renderer_info"),at=U.getParameter(rt?rt.UNMASKED_RENDERER_WEBGL:U.VENDOR);document.getElementById("info").innerHTML=`Renderer: ${at}`,N.onmousedown=()=>{},N.ontouchstart=()=>{},N.onmouseup=()=>{},N.ontouchend=()=>{},N.onclick=t=>{const e=z();var i=N.getBoundingClientRect();const n={x:(t.clientX-i.left)/3,y:(t.clientY-i.top)/3};for(const s of e)n.x>=s.pos.x&&n.x<s.pos.x+s.size.x&&n.y>=s.pos.y&&n.y<s.pos.y+s.size.y?s.selected(!s.isSelected):s.isSelected&&s.moveTo(n.x,n.y)},document.onkeydown=t=>{switch(t.key){case"r":z()[0].sprite.remove(),R=[];break;case"p":!function(){let t=new O(96,96);R.push(t)}()}};let ot=0;const ct=t=>{I.begin();for(const e of z())e.update((t-ot)/1e3);ot=t,f.render(),I.end(),requestAnimationFrame(ct)};requestAnimationFrame(ct);</script></head><body><canvas id="view"></canvas><div id="info"></div></body></html>